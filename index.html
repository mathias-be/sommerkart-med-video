<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sommerkart</title>

  <!--
    Denne filen viser et interaktivt kart over utvalgte badeplasser i
    Fredrikstad‚ÄìHvaler-regionen. Kartet er satt opp med Leaflet og
    OpenStreetMap som bakgrunnskart. N√•r du klikker p√• en badeplass
    vises informasjon om badetemperatur, artikler og video i en popup.
  -->

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #map {
      width: 100%;
      height: 80vh;
    }

    .popup-content {
      max-width: 400px;
    }

    .video-container {
      margin-top: 0.5rem;
    }

    .video-container video,
    .video-container iframe {
      width: 100%;
      height: 200px;
    }

    /* Emoji-mark√∏rer */
    .emoji-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      font-size: 28px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
    }

    .header-container h1 {
      font-family: "Georgia", "Times New Roman", serif;
      font-size: 2rem;
      text-align: center;
      margin: 0.5rem 0;
    }
  </style>
</head>
<body>
  <!-- Sidehode med tittel -->
  <div class="header-container">
    <h1>Sommerkart</h1>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Liste over badeplasser
    const bathingSpots = [
      {
        name: "Foten badeplass",
        lat: 59.1703546,
        lon: 10.8266099,
        temperature: 1,
        articles: [],
        videos: [
          {
            title: "Video fra Foten",
            url: "foten.mp4"
          }
        ]
      },
      {
        name: "Vispen",
        lat: 59.0,   // TODO: legg inn korrekte koordinater
        lon: 10.0,
        temperature: 3,
        articles: [],
        videos: []
      },
      {
        name: "Tangen",
        lat: 59.0,   // TODO: legg inn korrekte koordinater
        lon: 10.0,
        temperature: 4,
        articles: [],
        videos: []
      },
      {
        // Glufsa p√• Kr√•ker√∏y
        name: "Glufsa",
        lat: 59.17639104968224,
        lon: 10.882157758300316,
        temperature: 4,
        articles: [],
        videos: [
          {
            title: "Video fra Glufsa",
            url: "glufsa.mp4"
          }
        ]
      },
      {
        // M√¶rrapanna p√• Ons√∏y
        name: "M√¶rrapanna",
        lat: 59.1974631,
        lon: 10.7960442,
        temperature: 17,
        articles: [],
        videos: [
          {
            title: "Video fra M√¶rrapanna",
            url: "maerrapanna.mp4"   // s√∏rg for at filen heter dette
          }
        ]
      },
      {
        // Dammene i Fredrikstadmarka
        name: "Dammene",
        lat: 59.2323927,
        lon: 10.9475110,
        temperature: 20,
        articles: [],
        videos: [
          {
            title: "Video fra Dammene",
            url: "dammene.mp4"
          }
        ]
      },
      {
        // Gamlebyen / Vollane
        name: "Gamlebyen",
        lat: 59.200965,
        lon: 10.948700,
        temperature: null,
        articles: [],
        videos: [
          {
            title: "Jangle p√• Vollane",
            url: "jangle-pa-vollane.mp4"
          }
        ]
      },
      {
        // Fredrikstad sentrum
        name: "Fredrikstad sentrum",
        lat: 59.213174,
        lon: 10.935622,
        temperature: null,
        articles: [],
        videos: [
          {
            title: "Hva m√• du gj√∏re i varmen?",
            url: "varmen.mp4"
          }
        ]
      },
      {
        // IDYLL-festivalen
        name: "IDYLL Festivalen",
        lat: 59.202294,
        lon: 10.944766,
        temperature: null,
        articles: [],
        videos: [
          {
            title: "Idyll!",
            url: "idyll.mp4"
          }
        ]
      },
      {
        // Kirkens Bymisjon / S√ÜRPING√ÜR-videoen
        name: "Kirkens Bymisjon Fredrikstad",
        lat: 59.212354,
        lon: 10.935563,
        temperature: null,
        articles: [],
        videos: [
          {
            title: "S√ÜRPING√ÜR",
            url: "saerpingaer.mp4"
          }
        ]
      },
      {
        // Softis ‚Äì Nygaardsgata 4
        name: "Softis i Nygaardsgata",
        lat: 59.208470,
        lon: 10.941760,
        temperature: null,
        articles: [],
        videos: [
          {
            title: "Softis üç¶",
            url: "softis.mp4"
          }
        ]
      }

      // Her kan du legge til flere badeplasser senere
    ];

    // Opprett kartet
    const map = L.map("map").setView([59.171, 10.8], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> bidragsytere'
    }).addTo(map);

    // For √• kunne oppdatere popup senere
    const markerByName = {};

    // Emoji-ikoner
    const icons = {
      default: L.divIcon({
        className: "emoji-icon",
        html: "‚õ±Ô∏è",
        iconSize: [48, 48],
        iconAnchor: [24, 48]
      }),
      heat: L.divIcon({
        className: "emoji-icon",
        html: "ü•µ",
        iconSize: [48, 48],
        iconAnchor: [24, 48]
      }),
      soccer: L.divIcon({
        className: "emoji-icon",
        html: "‚öΩÔ∏è",
        iconSize: [48, 48],
        iconAnchor: [24, 48]
      }),
      microphone: L.divIcon({
        className: "emoji-icon",
        html: "üé§",
        iconSize: [48, 48],
        iconAnchor: [24, 48]
      })
    };

    // Hvilke steder som f√•r spesielle ikoner
    const iconForSpot = {
      "Fredrikstad sentrum": "heat",
      "Kirkens Bymisjon Fredrikstad": "soccer",
      "IDYLL Festivalen": "microphone"
    };

    // Bygger HTML til popup
    function buildPopupContent(spot) {
      const tempText = spot.temperature !== null ? `${spot.temperature} ¬∞C` : "Ukjent";
      let html = `<div class="popup-content"><h3>${spot.name}</h3>`;
      html += `<p><strong>Vanntemperatur:</strong> ${tempText}</p>`;

      if (spot.articles && spot.articles.length > 0) {
        html += "<p><strong>Artikler:</strong></p><ul>";
        spot.articles.forEach(article => {
          html += `<li><a href="${article.url}" target="_blank" rel="noopener noreferrer">${article.title}</a></li>`;
        });
        html += "</ul>";
      }

      if (spot.videos && spot.videos.length > 0) {
        html += "<p><strong>Video:</strong></p>";
        html += '<div class="video-container">';
        spot.videos.forEach(video => {
          // YouTube-h√•ndtering hvis du senere legger inn YouTube-lenker
          if (video.url.includes("youtube.com") || video.url.includes("youtu.be")) {
            let embedUrl = video.url;
            if (video.url.includes("youtu.be/")) {
              const videoId = video.url.split("youtu.be/")[1];
              embedUrl = `https://www.youtube.com/embed/${videoId}`;
            } else if (video.url.includes("watch?v=")) {
              const videoId = video.url.split("watch?v=")[1];
              embedUrl = `https://www.youtube.com/embed/${videoId}`;
            }
            html += `<iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
          } else {
            // Lokale videofiler (slik du har dem p√• GitHub)
            const urlWithEscapedQuestion = video.url.replace(/\?/g, "%3F");
            const safeUrl = encodeURI(urlWithEscapedQuestion);
            html += `<video controls preload="metadata">
              <source src="${safeUrl}" type="video/mp4">
              Nettleseren din st√∏tter ikke videovisning.
            </video>`;
          }
        });
        html += "</div>";
      }

      html += "</div>";
      return html;
    }

    // Legg ut alle mark√∏rer
    bathingSpots.forEach(spot => {
      const iconKey = iconForSpot[spot.name] || "default";
      const marker = L.marker([spot.lat, spot.lon], { icon: icons[iconKey] }).addTo(map);
      marker.bindPopup(buildPopupContent(spot));
      markerByName[spot.name] = marker;
    });

    // Henter badetemperaturer fra Fredrikstad kommune (kan kommenteres bort hvis un√∏dvendig)
    async function updateTemperatures() {
      try {
        const url =
          "https://arcgis.fredrikstad.kommune.no/server/rest/services/IOT/BadetemperaturInnsyn/MapServer/0/query?where=1%3D1&outFields=NAVN,TEMPERATUR,TIME&f=pjson";
        const response = await fetch(url);
        if (!response.ok) {
          console.warn("Fikk ikke tilgang til badetemperaturer fra kommunen");
          return;
        }
        const data = await response.json();
        if (data.features) {
          data.features.forEach(feature => {
            const attrs = feature.attributes || feature;
            const name = attrs.NAVN;
            const temp = attrs.TEMPERATUR;
            const spot = bathingSpots.find(
              s => s.name.toLowerCase() === String(name).toLowerCase()
            );
            if (spot) {
              spot.temperature = temp;
              const marker = markerByName[spot.name];
              if (marker) {
                marker.setPopupContent(buildPopupContent(spot));
              }
            }
          });
        }
      } catch (error) {
        console.error("Feil ved henting av badetemperaturer:", error);
      }
    }

    // Kall funksjonen (kan kommenteres bort)
    updateTemperatures();
  </script>
</body>
</html>
